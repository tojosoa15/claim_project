DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `SpVerificationProcessSurveyor`(
    IN p_claim_number VARCHAR(250),
    IN p_surveyor_id INT,
    IN p_status BOOLEAN,
    IN p_current_step VARCHAR(50),
    IN p_json_data JSON
)
BEGIN
    DECLARE v_verification_id INT;
    DECLARE v_estimate_of_repair_id INT;
    DECLARE v_part_detail_id INT;

    IF p_current_step = 'step_1' THEN
        -- Insert dans Survey
        INSERT INTO survey (surveyor_id, current_step, status_id, claim_number)
        VALUES (p_surveyor_id, p_current_step, p_status, p_claim_number);

        SET v_verification_id = LAST_INSERT_ID();

        -- Vehicle information depuis JSON
        INSERT INTO vehicle_information (
            verification_id, make, model, cc, fuel_type, transmission, engime_no, chasisi_no, vehicle_no, color, odometer_reading, is_the_vehicle_total_loss, condition_of_vehicle, place_of_survey, point_of_impact
        ) VALUES (
            v_verification_id,
            JSON_UNQUOTE(JSON_EXTRACT(p_json_data, '$.make')),
            JSON_UNQUOTE(JSON_EXTRACT(p_json_data, '$.model')),
            JSON_UNQUOTE(JSON_EXTRACT(p_json_data, '$.cc')),
            JSON_UNQUOTE(JSON_EXTRACT(p_json_data, '$.fuel_type')),
            JSON_UNQUOTE(JSON_EXTRACT(p_json_data, '$.transmission')),
            JSON_UNQUOTE(JSON_EXTRACT(p_json_data, '$.engime_no')),
            JSON_UNQUOTE(JSON_EXTRACT(p_json_data, '$.chasisi_no')),
            JSON_UNQUOTE(JSON_EXTRACT(p_json_data, '$.vehicle_no')),
            JSON_UNQUOTE(JSON_EXTRACT(p_json_data, '$.color')),
            JSON_UNQUOTE(JSON_EXTRACT(p_json_data, '$.odometer_reading')),
            JSON_UNQUOTE(JSON_EXTRACT(p_json_data, '$.is_the_vehicle_total_loss')),
            JSON_UNQUOTE(JSON_EXTRACT(p_json_data, '$.condition_of_vehicle')),
            JSON_UNQUOTE(JSON_EXTRACT(p_json_data, '$.place_of_survey')),
            JSON_UNQUOTE(JSON_EXTRACT(p_json_data, '$.point_of_impact'))
        );

        -- Mettre à jour l'étape
        UPDATE survey
        SET current_step = p_current_step
        WHERE id = v_verification_id;

    ELSEIF p_current_step = 'step_2' THEN
        SELECT id INTO v_verification_id
        FROM survey
        WHERE claim_number = p_claim_number AND surveyor_id = p_surveyor_id
        LIMIT 1;

        -- Survey information depuis JSON
        INSERT INTO survey_information (
            verification_id, garage, garage_address, garage_contact_number, eor_value, invoice_number, survey_type, date_of_survey, time_of_survey, pre_accident_valeur, showroom_price, wrech_value, excess_applicable
        )
        VALUES (
            v_verification_id,
            JSON_UNQUOTE(JSON_EXTRACT(p_json_data, '$.garage')),
            JSON_UNQUOTE(JSON_EXTRACT(p_json_data, '$.garage_address')),
            JSON_UNQUOTE(JSON_EXTRACT(p_json_data, '$.garage_contact_number')),
            JSON_UNQUOTE(JSON_EXTRACT(p_json_data, '$.eor_value')),
            JSON_UNQUOTE(JSON_EXTRACT(p_json_data, '$.invoice_number')),
            JSON_UNQUOTE(JSON_EXTRACT(p_json_data, '$.survey_type')),
            JSON_UNQUOTE(JSON_EXTRACT(p_json_data, '$.date_of_survey')),
            JSON_UNQUOTE(JSON_EXTRACT(p_json_data, '$.time_of_survey')),
            JSON_UNQUOTE(JSON_EXTRACT(p_json_data, '$.pre_accident_valeur')),
            JSON_UNQUOTE(JSON_EXTRACT(p_json_data, '$.showroom_price')),
            JSON_UNQUOTE(JSON_EXTRACT(p_json_data, '$.wrech_value')),
            JSON_UNQUOTE(JSON_EXTRACT(p_json_data, '$.excess_applicable'))
        );

        -- Mettre à jour l'étape
        UPDATE survey
        SET current_step = p_current_step
        WHERE id = v_verification_id;

    ELSEIF p_current_step = 'step_3' THEN
        SELECT id INTO v_verification_id
        FROM survey
        WHERE claim_number = p_claim_number AND surveyor_id = p_surveyor_id
        LIMIT 1;

        -- Estimate of repair depuis JSON
        INSERT INTO estimate_of_repair (verification_id, current_editor, remarks)
        VALUES (
            v_verification_id,
            JSON_UNQUOTE(JSON_EXTRACT(p_json_data, '$.current_editor')),
            JSON_EXTRACT(p_json_data, '$.remarks')
        );

        SET v_estimate_of_repair_id = LAST_INSERT_ID();

        -- Part detail information depuis JSON
        -- Boucle sur le tableau des pièces
        SET @i = 0;
        SET @total_parts = JSON_LENGTH(JSON_EXTRACT(p_json_data, '$.parts'));

        WHILE @i < @total_parts DO
            -- Insertion dans part_detail
            INSERT INTO part_detail (
                estimate_of_repair_id,
                part_name,
                quantity,
                supplier,
                quality,
                cost_part,
                discount_part,
                vat_part,
                part_total
            ) VALUES (
                v_estimate_of_repair_id,
                JSON_UNQUOTE(JSON_EXTRACT(p_json_data, CONCAT('$.parts[', @i, '].part_name'))),
                JSON_EXTRACT(p_json_data, CONCAT('$.parts[', @i, '].quantity')),
                JSON_UNQUOTE(JSON_EXTRACT(p_json_data, CONCAT('$.parts[', @i, '].supplier'))),
                JSON_UNQUOTE(JSON_EXTRACT(p_json_data, CONCAT('$.parts[', @i, '].quality'))),
                JSON_EXTRACT(p_json_data, CONCAT('$.parts[', @i, '].cost_part')),
                JSON_EXTRACT(p_json_data, CONCAT('$.parts[', @i, '].discount_part')),
                JSON_EXTRACT(p_json_data, CONCAT('$.parts[', @i, '].vat_part')),
                JSON_EXTRACT(p_json_data, CONCAT('$.parts[', @i, '].part_total'))
            );

            SET v_part_detail_id = LAST_INSERT_ID();

            -- Insertion correspondante dans labour_detail
            INSERT INTO labour_detail (
                part_detail_id,
                eor_or_surveyor,
                activity,
                number_of_hours,
                hourly_const_labour,
                discount_labour,
                vat_labour,
                labour_total
            ) VALUES (
                v_part_detail_id,
                JSON_UNQUOTE(JSON_EXTRACT(p_json_data, CONCAT('$.labours[', @i, '].eor_or_surveyor'))),
                JSON_UNQUOTE(JSON_EXTRACT(p_json_data, CONCAT('$.labours[', @i, '].activity'))),
                JSON_EXTRACT(p_json_data, CONCAT('$.labours[', @i, '].number_of_hours')),
                JSON_EXTRACT(p_json_data, CONCAT('$.labours[', @i, '].hourly_const_labour')),
                JSON_EXTRACT(p_json_data, CONCAT('$.labours[', @i, '].discount_labour')),
                JSON_EXTRACT(p_json_data, CONCAT('$.labours[', @i, '].vat_labour')),
                JSON_EXTRACT(p_json_data, CONCAT('$.labours[', @i, '].labour_total'))
            );

            SET @i = @i + 1;
        END WHILE;

        -- Mettre à jour l'étape
        UPDATE survey
        SET current_step = p_current_step
        WHERE id = v_verification_id;

    ELSEIF p_current_step = 'step_4' THEN
        SELECT id INTO v_verification_id
        FROM survey
        WHERE claim_number = p_claim_number AND surveyor_id = p_surveyor_id
        LIMIT 1;

        -- Mettre à jour l'étape
        UPDATE survey
        SET current_step = p_current_step, status_id = 1
        WHERE id = v_verification_id;
    END IF;

    -- Tu peux faire un SELECT de retour ici si tu veux
    SELECT 'Mise à jour verification réussie' AS message;
END$$
DELIMITER ;